from typing import Any, List, Optional, Tuple
from zencfg import ConfigBase
from pydantic import field_validator
from .distributed import DistributedConfig
from .models import FNOConfig
from .opt import OptimizationConfig, PatchingConfig
from .wandb import WandbConfig


class CAMELSDatasetConfig(ConfigBase):
    attr_path: str = "/Volumes/Untitled/cache/camels_us_attributes.nc"
    ts_path: str = "/Volumes/Untitled/cache/camels_us_timeseries.nc"
    batch_size: int = 64
    test_batch_sizes: List[int] = [64]
    t_range_train: Tuple[str, str] = ("1980-01-01", "2004-12-31")
    t_range_test: Tuple[str, str] = ("2010-01-01", "2014-12-31")
    n_train: int = 600
    n_tests: List[int] = [50]
    static_features: Optional[List[str]] = [
        "elev_mean",
        "slope_mkm1",  # ← slope_mean
        "area_km2",  # ← area
        "frac_forest",
        "lai_max",
        "lai_diff",
        "dom_land_cover_frac",
        # "dom_land_cover",
        "root_depth_50",
        "soil_depth_statsgo",
        "soil_porosity",
        "soil_conductivity",
        "max_water_content",
        # "geol_1st_class",
        # "geol_2nd_class",
        "geol_porostiy",
        "geol_permeability",
    ]
    dynamic_features: Optional[List[str]] = [
        "dayl",
        "pcp_mm",
        "solrad_wm2",
        "airtemp_c_max",
        "airtemp_c_min",
        "vp_hpa",
    ]
    train_basins: Optional[List[str]] = [
        "01022500",
        "01030500",
        "01047000",
        "01054200",
        "01057000",
        "01073000",
        "01118300",
        "01123000",
        "01134500",
        "01137500",
        "01139000",
        "01139800",
        "01142500",
        "01144000",
        "01169000",
        "01170100",
        "01181000",
        "01187300",
        "01195100",
        "01333000",
        "01350000",
        "01350080",
        "01350140",
        "01411300",
        "01413500",
        "01414500",
        "01415000",
        "01423000",
        "01434025",
        "01435000",
        "01440000",
        "01440400",
        "01451800",
        "01466500",
        "01484100",
        "01485500",
        "01486000",
        "01487000",
        "01491000",
        "01510000",
        "01518862",
        "01532000",
        "01539000",
        "01542810",
        "01543000",
        "01545600",
        "01547700",
        "01548500",
        "01549500",
        "01552000",
        "01552500",
        "01557500",
        "01567500",
        "01580000",
        "01586610",
        "01594950",
        "01596500",
        "01605500",
        "01606500",
        "01613050",
        "01620500",
        "01632000",
        "01632900",
        "01634500",
        "01638480",
        "01639500",
        "01658500",
        "01664000",
        "01667500",
        "01669000",
        "02011460",
        "02013000",
        "02014000",
        "02015700",
        "02018000",
        "02027000",
        "02027500",
        "02038850",
        "02053200",
        "02053800",
        "02055100",
        "02064000",
        "02069700",
        "02070000",
        "02074500",
        "02077200",
        "02081500",
        "02092500",
        "02096846",
        "02102908",
        "02108000",
        "02111500",
        "02112120",
        "02112360",
        "02118500",
        "02125000",
        "02128000",
        "02137727",
        "02140991",
        "02143040",
        "02177000",
        "02178400",
        "02193340",
        "02196000",
        "02198100",
        "02202600",
        "02212600",
        "02215100",
        "02221525",
        "02231000",
        "02231342",
        "02235200",
        "02246000",
        "02296500",
        "02297155",
        "02297310",
        "02298123",
        "02298608",
        "02299950",
        "02300700",
        "02310947",
        "02312200",
        "02314500",
        "02315500",
        "02324400",
        "02327100",
        "02342933",
        "02350900",
        "02361000",
        "02363000",
        "02371500",
        "02374500",
        "02381600",
        "02384540",
        "02408540",
        "02415000",
        "02422500",
        "02427250",
        "02430615",
        "02450250",
        "02464000",
        "02464146",
        "02464360",
        "02469800",
        "02472000",
        "02479155",
        "02479300",
        "02479560",
        "02481000",
        "03010655",
        "03011800",
        "03015500",
        "03021350",
        "03026500",
        "03049000",
        "03049800",
        "03050000",
        "03069500",
        "03078000",
        "03140000",
        "03144000",
        "03159540",
        "03161000",
        "03164000",
        "03165000",
        "03170000",
        "03173000",
        "03180500",
        "03182500",
        "03187500",
        "03213700",
        "03237280",
        "03237500",
        "03238500",
        "03241500",
        "03280700",
        "03281100",
        "03281500",
        "03285000",
        "03300400",
        "03346000",
        "03357350",
        "03364500",
        "03366500",
        "03368000",
        "03384450",
        "03439000",
        "03450000",
        "03456500",
        "03460000",
        "03463300",
        "03471500",
        "03473000",
        "03479000",
        "03488000",
        "03498500",
        "03500000",
        "03504000",
        "03592718",
        "03604000",
        "04024430",
        "04027000",
        "04040500",
        "04043050",
        "04045500",
        "04056500",
        "04057510",
        "04057800",
        "04059500",
        "04063700",
        "04105700",
        "04115265",
        "04122200",
        "04122500",
        "04124000",
        "04127918",
        "04127997",
        "04185000",
        "04196800",
        "04197100",
        "04197170",
        "04213000",
        "04216418",
        "04221000",
        "04224775",
        "04233000",
        "04256000",
        "04296000",
        "05057200",
        "05062500",
        "05087500",
        "05120500",
        "05123400",
        "05129115",
        "05131500",
        "05291000",
        "05362000",
        "05393500",
        "05399500",
        "05408000",
        "05412500",
        "05444000",
        "05454000",
        "05458000",
        "05466500",
        "05487980",
        "05489000",
        "05495000",
        "05503800",
        "05507600",
        "05514500",
        "05525500",
        "05556500",
        "05584500",
        "05585000",
        "05591550",
        "05592050",
        "05592575",
        "05593900",
        "05595730",
        "06043500",
        "06154410",
        "06188000",
        "06191500",
        "06221400",
        "06278300",
        "06280300",
        "06291500",
        "06311000",
        "06332515",
        "06339500",
        "06344600",
        "06350000",
        "06352000",
        "06353000",
        "06354000",
        "06360500",
        "06404000",
        "06406000",
        "06408700",
        "06409000",
        "06431500",
        "06440200",
        "06447000",
        "06447500",
        "06452000",
        "06453600",
        "06464500",
        "06468250",
        "06470800",
        "06477500",
        "06479215",
        "06479438",
        "06601000",
        "06614800",
        "06622700",
        "06623800",
        "06632400",
        "06803530",
        "06814000",
        "06847900",
        "06853800",
        "06878000",
        "06879650",
        "06885500",
        "06888500",
        "06889200",
        "06889500",
        "06892000",
        "06906800",
        "06910800",
        "06911900",
        "06917000",
        "06918460",
        "06919500",
        "06921200",
        "06934000",
        "07014500",
        "07056000",
        "07057500",
        "07060710",
        "07066000",
        "07067000",
        "07068000",
        "07071500",
        "07083000",
        "07142300",
        "07145700",
        "07148400",
        "07151500",
        "07167500",
        "07180500",
        "07184000",
        "07195800",
        "07196900",
        "07197000",
        "07226500",
        "07261000",
        "07263295",
        "07290650",
        "07291000",
        "07292500",
        "07295000",
        "07299670",
        "07301410",
        "07301500",
        "07335700",
        "07340300",
        "07346045",
        "07359610",
        "07362587",
        "07373000",
        "07376000",
        "08013000",
        "08023080",
        "08025500",
        "08029500",
        "08066200",
        "08066300",
        "08070000",
        "08079600",
        "08082700",
        "08086212",
        "08086290",
        "08101000",
        "08103900",
        "08109700",
        "08150800",
        "08155200",
        "08158700",
        "08158810",
        "08164000",
        "08164600",
        "08165300",
        "08176900",
        "08189500",
        "08190000",
        "08190500",
        "08194200",
        "08195000",
        "08196000",
        "08202700",
        "08267500",
        "08269000",
        "08324000",
        "08378500",
        "09034900",
        "09035800",
        "09035900",
        "09065500",
        "09066000",
        "09066200",
        "09066300",
        "09081600",
        "09210500",
        "09223000",
        "09306242",
        "09352900",
        "09378170",
        "09378630",
        "09386900",
        "09404450",
        "09430600",
        "09447800",
        "09480000",
        "09484600",
        "09492400",
        "09494000",
        "09497800",
        "09505200",
        "09505350",
        "09505800",
        "09508300",
        "09510200",
        "09512280",
        "09513780",
        "10023000",
        "10166430",
        "10172700",
        "10172800",
        "10173450",
        "10205030",
        "10242000",
        "10249300",
        "10258000",
        "10258500",
        "10259000",
        "10259200",
        "10263500",
        "10310500",
        "10316500",
        "10329500",
        "10336645",
        "10336660",
        "10336740",
        "10343500",
        "11098000",
        "11124500",
        "11141280",
        "11143000",
        "11148900",
        "11151300",
        "11176400",
        "11180500",
        "11224500",
        "11230500",
        "11237500",
        "11264500",
        "11266500",
        "11274500",
        "11274630",
        "11284400",
        "11299600",
        "11383500",
        "11451100",
        "11468500",
        "11475560",
        "11476600",
        "11480390",
        "11481200",
        "11482500",
        "11528700",
        "11532500",
        "12010000",
        "12013500",
        "12020000",
        "12025700",
        "12035000",
        "12040500",
        "12041200",
        "12043000",
        "12048000",
        "12056500",
        "12073500",
        "12082500",
        "12095000",
        "12115000",
        "12115500",
        "12117000",
        "12143600",
        "12144000",
        "12145500",
        "12147500",
        "12147600",
        "12175500",
        "12178100",
        "12186000",
        "12189500",
        "12358500",
        "12375900",
        "12381400",
        "12383500",
        "12388400",
        "12390700",
        "12414500",
        "12447390",
        "12451000",
        "12488500",
        "13011500",
        "13011900",
        "13083000",
        "13161500",
        "13235000",
        "13240000",
        "13310700",
        "13331500",
        "13337000",
        "13338500",
        "13340000",
        "13340600",
        "14020000",
        "14092750",
        "14096850",
        "14137000",
        "14138800",
        "14138870",
        "14139800",
        "14141500",
        "14158500",
        "14158790",
        "14182500",
        "14185000",
        "14187000",
        "14216500",
        "14222500",
        "14236200",
        "14301000",
        "14303200",
        "14305500",
        "14306340",
        "14306500",
        "14308990",
        "14309500",
        "14316700",
        "14325000",
        "14400000",
    ]
    test_basins: Optional[List[str]] = [
        "01022500",
        "01030500",
        "01047000",
        "01054200",
        "01057000",
        "01073000",
        "01118300",
        "01123000",
        "01134500",
        "01137500",
        "01139000",
        "01139800",
        "01142500",
        "01144000",
        "01169000",
        "01170100",
        "01181000",
        "01187300",
        "01195100",
        "01333000",
        "01350000",
        "01350080",
        "01350140",
        "01411300",
        "01413500",
        "01414500",
        "01415000",
        "01423000",
        "01434025",
        "01435000",
        "01440000",
        "01440400",
        "01451800",
        "01466500",
        "01484100",
        "01485500",
        "01486000",
        "01487000",
        "01491000",
        "01510000",
        "01518862",
        "01532000",
        "01539000",
        "01542810",
        "01543000",
        "01545600",
        "01547700",
        "01548500",
        "01549500",
        "01552000",
        "01552500",
        "01557500",
        "01567500",
        "01580000",
        "01586610",
        "01594950",
        "01596500",
        "01605500",
        "01606500",
        "01613050",
        "01620500",
        "01632000",
        "01632900",
        "01634500",
        "01638480",
        "01639500",
        "01658500",
        "01664000",
        "01667500",
        "01669000",
        "02011460",
        "02013000",
        "02014000",
        "02015700",
        "02018000",
        "02027000",
        "02027500",
        "02038850",
        "02053200",
        "02053800",
        "02055100",
        "02064000",
        "02069700",
        "02070000",
        "02074500",
        "02077200",
        "02081500",
        "02092500",
        "02096846",
        "02102908",
        "02108000",
        "02111500",
        "02112120",
        "02112360",
        "02118500",
        "02125000",
        "02128000",
        "02137727",
        "02140991",
        "02143040",
        "02177000",
        "02178400",
        "02193340",
        "02196000",
        "02198100",
        "02202600",
        "02212600",
        "02215100",
        "02221525",
        "02231000",
        "02231342",
        "02235200",
        "02246000",
        "02296500",
        "02297155",
        "02297310",
        "02298123",
        "02298608",
        "02299950",
        "02300700",
        "02310947",
        "02312200",
        "02314500",
        "02315500",
        "02324400",
        "02327100",
        "02342933",
        "02350900",
        "02361000",
        "02363000",
        "02371500",
        "02374500",
        "02381600",
        "02384540",
        "02408540",
        "02415000",
        "02422500",
        "02427250",
        "02430615",
        "02450250",
        "02464000",
        "02464146",
        "02464360",
        "02469800",
        "02472000",
        "02479155",
        "02479300",
        "02479560",
        "02481000",
        "03010655",
        "03011800",
        "03015500",
        "03021350",
        "03026500",
        "03049000",
        "03049800",
        "03050000",
        "03069500",
        "03078000",
        "03140000",
        "03144000",
        "03159540",
        "03161000",
        "03164000",
        "03165000",
        "03170000",
        "03173000",
        "03180500",
        "03182500",
        "03187500",
        "03213700",
        "03237280",
        "03237500",
        "03238500",
        "03241500",
        "03280700",
        "03281100",
        "03281500",
        "03285000",
        "03300400",
        "03346000",
        "03357350",
        "03364500",
        "03366500",
        "03368000",
        "03384450",
        "03439000",
        "03450000",
        "03456500",
        "03460000",
        "03463300",
        "03471500",
        "03473000",
        "03479000",
        "03488000",
        "03498500",
        "03500000",
        "03504000",
        "03592718",
        "03604000",
        "04024430",
        "04027000",
        "04040500",
        "04043050",
        "04045500",
        "04056500",
        "04057510",
        "04057800",
        "04059500",
        "04063700",
        "04105700",
        "04115265",
        "04122200",
        "04122500",
        "04124000",
        "04127918",
        "04127997",
        "04185000",
        "04196800",
        "04197100",
        "04197170",
        "04213000",
        "04216418",
        "04221000",
        "04224775",
        "04233000",
        "04256000",
        "04296000",
        "05057200",
        "05062500",
        "05087500",
        "05120500",
        "05123400",
        "05129115",
        "05131500",
        "05291000",
        "05362000",
        "05393500",
        "05399500",
        "05408000",
        "05412500",
        "05444000",
        "05454000",
        "05458000",
        "05466500",
        "05487980",
        "05489000",
        "05495000",
        "05503800",
        "05507600",
        "05514500",
        "05525500",
        "05556500",
        "05584500",
        "05585000",
        "05591550",
        "05592050",
        "05592575",
        "05593900",
        "05595730",
        "06043500",
        "06154410",
        "06188000",
        "06191500",
        "06221400",
        "06278300",
        "06280300",
        "06291500",
        "06311000",
        "06332515",
        "06339500",
        "06344600",
        "06350000",
        "06352000",
        "06353000",
        "06354000",
        "06360500",
        "06404000",
        "06406000",
        "06408700",
        "06409000",
        "06431500",
        "06440200",
        "06447000",
        "06447500",
        "06452000",
        "06453600",
        "06464500",
        "06468250",
        "06470800",
        "06477500",
        "06479215",
        "06479438",
        "06601000",
        "06614800",
        "06622700",
        "06623800",
        "06632400",
        "06803530",
        "06814000",
        "06847900",
        "06853800",
        "06878000",
        "06879650",
        "06885500",
        "06888500",
        "06889200",
        "06889500",
        "06892000",
        "06906800",
        "06910800",
        "06911900",
        "06917000",
        "06918460",
        "06919500",
        "06921200",
        "06934000",
        "07014500",
        "07056000",
        "07057500",
        "07060710",
        "07066000",
        "07067000",
        "07068000",
        "07071500",
        "07083000",
        "07142300",
        "07145700",
        "07148400",
        "07151500",
        "07167500",
        "07180500",
        "07184000",
        "07195800",
        "07196900",
        "07197000",
        "07226500",
        "07261000",
        "07263295",
        "07290650",
        "07291000",
        "07292500",
        "07295000",
        "07299670",
        "07301410",
        "07301500",
        "07335700",
        "07340300",
        "07346045",
        "07359610",
        "07362587",
        "07373000",
        "07376000",
        "08013000",
        "08023080",
        "08025500",
        "08029500",
        "08066200",
        "08066300",
        "08070000",
        "08079600",
        "08082700",
        "08086212",
        "08086290",
        "08101000",
        "08103900",
        "08109700",
        "08150800",
        "08155200",
        "08158700",
        "08158810",
        "08164000",
        "08164600",
        "08165300",
        "08176900",
        "08189500",
        "08190000",
        "08190500",
        "08194200",
        "08195000",
        "08196000",
        "08202700",
        "08267500",
        "08269000",
        "08324000",
        "08378500",
        "09034900",
        "09035800",
        "09035900",
        "09065500",
        "09066000",
        "09066200",
        "09066300",
        "09081600",
        "09210500",
        "09223000",
        "09306242",
        "09352900",
        "09378170",
        "09378630",
        "09386900",
        "09404450",
        "09430600",
        "09447800",
        "09480000",
        "09484600",
        "09492400",
        "09494000",
        "09497800",
        "09505200",
        "09505350",
        "09505800",
        "09508300",
        "09510200",
        "09512280",
        "09513780",
        "10023000",
        "10166430",
        "10172700",
        "10172800",
        "10173450",
        "10205030",
        "10242000",
        "10249300",
        "10258000",
        "10258500",
        "10259000",
        "10259200",
        "10263500",
        "10310500",
        "10316500",
        "10329500",
        "10336645",
        "10336660",
        "10336740",
        "10343500",
        "11098000",
        "11124500",
        "11141280",
        "11143000",
        "11148900",
        "11151300",
        "11176400",
        "11180500",
        "11224500",
        "11230500",
        "11237500",
        "11264500",
        "11266500",
        "11274500",
        "11274630",
        "11284400",
        "11299600",
        "11383500",
        "11451100",
        "11468500",
        "11475560",
        "11476600",
        "11480390",
        "11481200",
        "11482500",
        "11528700",
        "11532500",
        "12010000",
        "12013500",
        "12020000",
        "12025700",
        "12035000",
        "12040500",
        "12041200",
        "12043000",
        "12048000",
        "12056500",
        "12073500",
        "12082500",
        "12095000",
        "12115000",
        "12115500",
        "12117000",
        "12143600",
        "12144000",
        "12145500",
        "12147500",
        "12147600",
        "12175500",
        "12178100",
        "12186000",
        "12189500",
        "12358500",
        "12375900",
        "12381400",
        "12383500",
        "12388400",
        "12390700",
        "12414500",
        "12447390",
        "12451000",
        "12488500",
        "13011500",
        "13011900",
        "13083000",
        "13161500",
        "13235000",
        "13240000",
        "13310700",
        "13331500",
        "13337000",
        "13338500",
        "13340000",
        "13340600",
        "14020000",
        "14092750",
        "14096850",
        "14137000",
        "14138800",
        "14138870",
        "14139800",
        "14141500",
        "14158500",
        "14158790",
        "14182500",
        "14185000",
        "14187000",
        "14216500",
        "14222500",
        "14236200",
        "14301000",
        "14303200",
        "14305500",
        "14306340",
        "14306500",
        "14308990",
        "14309500",
        "14316700",
        "14325000",
        "14400000",
    ]

    @field_validator(
        "train_basins",
        "test_basins",
        "static_features",
        "dynamic_features",
        mode="before",
    )
    @classmethod
    def split_str_to_list(cls, v):
        if isinstance(v, str):
            v = v.replace("[", "").replace("]", "").replace("'", "").replace('"', "")
            return [s.strip() for s in v.split(",") if s.strip()]
        return v


class CAMELSFNOConfig(FNOConfig):
    n_modes: List[int] = [16]
    hidden_channels: int = 64
    in_channels: int = 8
    out_channels: int = 1
    n_layers: int = 4


class Default(ConfigBase):
    n_params_baseline: Optional[Any] = None
    verbose: bool = True
    arch: str = "fno"
    distributed: DistributedConfig = DistributedConfig()
    model: CAMELSFNOConfig = CAMELSFNOConfig(
        data_channels=8, out_channels=1, n_modes=[16], hidden_channels=64
    )
    opt: OptimizationConfig = OptimizationConfig(n_epochs=100)
    data: CAMELSDatasetConfig = CAMELSDatasetConfig()
    patching: PatchingConfig = PatchingConfig()
    wandb: WandbConfig = WandbConfig(group="camels")
